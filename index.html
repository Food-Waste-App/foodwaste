<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Food Waste Prevention and Donation System</title>

  <!-- NEW: css path -->
  <link rel="stylesheet" href="assets/css/main.css" />
  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
</head>
<body>

<header>
  <h1>Food Waste Donation & Discount System</h1>
</header>

<div class="container">

  <div id="authSection" class="content-section">
    <h2 id="authTitle">Login</h2>
    <div class="error" id="errorMessage"></div>

    <div class="tabs">
      <button class="tab-button active" onclick="setMode('login')">Login</button>
      <button class="tab-button" onclick="setMode('register')">Register</button>
    </div>

    <div class="role-buttons">
      <button class="role-btn active" onclick="setRole('user')">User</button>
      <button class="role-btn" onclick="setRole('business')">Business</button>
    </div>

    <div id="authForm" class="auth-form"></div>

    <button onclick="handleAuth()">Continue</button>
  </div>

  <div id="userSection" class="content-section hidden opaque-surface">
    <div class="topbar">
  <div class="topbar-left">
<div class="welcome-text">
      <div class="welcome-title">
        <span id="userWelcome">Welcome, User!</span>
        <span class="role-badge" id="userRoleBadge">USER</span>
      </div>
</div>
  </div>

  <div class="topbar-right">
    <button class="icon-btn nav-btn" onclick="openUserProfile()">My Profile</button>
    <button class="icon-btn nav-btn" onclick="openNotifications()">Notifications <span id="notifCount" class="notif-badge">0</span></button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>


    <hr style="margin:20px 0;">

    <h3>Filter</h3>
    <select id="filterCity" onchange="loadDistricts(); renderProducts();">
      <option value="">Select City</option>
    </select>

    <select id="filterDistrict" onchange="renderProducts()">
      <option value="">Select District</option>
    </select>

    <p class="warning">ID / name verification will be required during pickup.</p>

    <h3>Products</h3>
    <div id="productList" class="product-list">
      <p>No active products available.</p>
    </div>

    <hr style="margin:20px 0;">

    <h3>My Cart</h3>
    <ul id="cartItems"></ul>
    <button id="reserveBtn" onclick="reserveProducts()">Reserve</button>
    <button onclick="clearCart()">Clear Cart</button>

    <hr style="margin:20px 0;">

    <h3>My Order History</h3>
    <div id="userOrderHistory">
      <p>No past orders yet.</p>
    </div>
  </div>


  <div id="userProfileSection" class="content-section hidden opaque-surface">
    <div class="topbar">
      <div class="topbar-left">
<div class="welcome-text">
          <div class="welcome-title">
            <span id="userProfileTitle">My Profile</span>
            <span class="role-badge">USER</span>
          </div>
          <div class="welcome-subtitle">Personal info and address.</div>
        </div>
      </div>
      <div class="topbar-right">
        <button class="icon-btn nav-btn" onclick="showPage('userSection')">← Dashboard</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>


    <div class="card" id="userProfileFormCard">
      <h3>Personal Info</h3>
      <div class="error" id="userProfileError"></div>

      <div class="form-grid">
        <div class="form-field">
          <label for="profileNameInput">Full Name</label>
          <input type="text" id="profileNameInput" placeholder="Full Name">
        </div>

        <div class="form-field">
          <label for="profileEmailInput">Email</label>
          <input type="email" id="profileEmailInput">
        </div>

        <div class="form-field">
          <label for="profilePhoneInput">Phone</label>
          <input type="tel" id="profilePhoneInput" placeholder="05xxxxxxxxx" inputmode="numeric" maxlength="11" autocomplete="tel">
        </div>
      </div>

      <div class="actions-row">
        <button class="icon-btn" onclick="saveUserProfile()">Save Changes</button>
      </div>
    </div>



    <div class="card">
      <h3>My Address</h3>
      <div id="userAddressCard"></div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="icon-btn" onclick="requestBrowserLocation()">Use my current location</button>
        <button class="icon-btn" onclick="resetDerivedLocation()">Reset to saved address location</button>
      </div>
      <p class="warning" style="margin-top:10px;">Distance (5 km) is calculated using your saved coordinates.</p>
    </div>

    <div class="card">
      <h3>Map View</h3>
      <div class="map-toolbar">
        <label><input type="checkbox" id="onlyNearbyToggle" checked onchange="renderUserMapMarkers()"> Show only within 5 km</label>
      </div>
      <div id="userMap" class="map"></div>
      <p class="warning" style="margin-top:10px;">Tip: click on the map to set your location more accurately.</p>
    </div>
  </div>

  <div id="userNotificationsSection" class="content-section hidden opaque-surface">
    <div class="topbar">
      <div class="topbar-left">
        <div class="welcome-text">
          <div class="welcome-title">
            <span>Notifications</span>
            <span class="role-badge">USER</span>
          </div>
          <div class="welcome-subtitle">Only your notifications.</div>
        </div>
      </div>
      <div class="topbar-right">
        <button class="icon-btn nav-btn" onclick="showPage('userSection')">← Dashboard</button>
        <button class="icon-btn nav-btn" onclick="openUserProfile()">My Profile</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="card">
      <div id="notifList"><p>No notifications.</p></div>
      <button class="icon-btn" onclick="clearNotifications()">Clear Notifications</button>
    </div>
  </div>

<div id="businessSection" class="content-section hidden opaque-surface">
   <div class="topbar">
  <div class="topbar-left">
<div class="welcome-text">
      <div class="welcome-title">
        <span id="businessWelcome">Welcome, Business!</span>
        <span class="role-badge business" id="businessRoleBadge">BUSINESS</span>
      </div>
</div>
  </div>

  <div class="topbar-right">
    <button class="icon-btn nav-btn" onclick="scrollToBusiness('activeReservations')">Active Reservations</button>
    <button class="icon-btn nav-btn" onclick="scrollToBusiness('addProductAnchor')">Add Product</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>


    <hr style="margin:20px 0;">

    <div class="business-actions">
      <button id="scanQrBtn" style="width:auto; background: var(--sage);" onclick="openScanModal()">Scan QR</button>
      <span class="muted-note">Scan customer QR to verify the order, then confirm delivery.</span>
    </div>

    <h3 style="margin-top:14px;">Active Reservations</h3>
    <div id="activeReservations">
      <p>There are no active reservations for your products.</p>
    </div>

    <hr style="margin:20px 0;">

    <h3>Order History</h3>
    <div id="businessOrderHistory">
      <p>No delivered orders yet.</p>
    </div>

    <hr style="margin:20px 0;">

    <div id="addProductAnchor"></div>
    <h3>Add New Product</h3>
    <div class="error" id="businessError"></div>

    <select id="newProductType" onchange="togglePriceInputs()">
      <option value="Donation">Donation (Free)</option>
      <option value="Discounted">Discounted Sale</option>
    </select>

    <input type="text" id="newProductName" placeholder="Product name (e.g. Bagel)">

    <label for="newProductImage" style="display:block; margin-top:10px;">Product Image:</label>
    <input type="file" id="newProductImage" accept="image/*">

    <input type="number" id="newProductStock" placeholder="Stock quantity" min="1" style="margin-top:10px;">

    <div id="priceInputs" class="hidden">
      <input type="number" id="oldPrice" placeholder="Original price">
      <input type="number" id="newPrice" placeholder="Discounted price">
    </div>

    <button onclick="addProduct()">Add Product</button>

    <hr style="margin:20px 0;">

    <h3>Your Products</h3>
    <div id="businessProductList" class="product-list">
      <p>You have not added any products yet.</p>
    </div>
  </div>

  <div id="businessProfileSection" class="content-section hidden opaque-surface">
    <h2 id="profileBusinessName">Business Profile</h2>
    <p><strong>Address:</strong> <span id="profileAddress"></span></p>
    <p><strong>City/District:</strong> <span id="profileCityDistrict"></span></p>
    <p><strong>Phone:</strong> <span id="profilePhone"></span></p>

    <hr>

    <h3>Other Products</h3>
    <div id="profileOtherProducts" class="product-list"></div>

    <button onclick="showUserSectionOnly()">Go Back</button>
  </div>

</div>

<!-- USER QR RESULT MODAL -->
<div id="qrModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2>Reservation Successful!</h2>
    <p>Show this QR code to the business owner.</p>
    <div id="qrCodeContainer"></div>
    <p id="qrOrderDetails" style="font-size:12px; margin-top:10px; color: var(--sage);"></p>
  </div>
</div>

<!-- BUSINESS QR SCAN MODAL -->
<div id="scanModal" class="modal">
  <div class="modal-content scan-modal">
    <span class="close-btn" onclick="closeScanModal()">&times;</span>
    <h2>Scan Customer QR</h2>

    <div class="scan-wrap">
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" class="hidden"></canvas>
    </div>

    <div id="scanStatus" class="scan-status">Camera is off.</div>

    <div id="scanResult" class="scan-result hidden">
      <h3>Order Details</h3>
      <div id="scanResultText" class="scan-result-text"></div>

      <button id="confirmDeliveredBtn" style="background: var(--sage);" onclick="confirmDeliveredFromScan()" disabled>
        Confirm Delivered
      </button>
    </div>

    <p class="scan-hint">
      If scanning does not work on your browser, use a QR scanner app on your phone and manually verify the details.
    </p>
  </div>
</div>

<!-- NEW: split JS files in correct order -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="assets/js/state.js"></script>
<script src="assets/js/helpers.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/business.js"></script>
<script src="assets/js/user.js"></script>

  <div id="toastContainer" class="toast-container"></div>
  <button id="backToTop" class="back-to-top" onclick="scrollToTop()" aria-label="Back to top">↑</button>
</body>
</html>